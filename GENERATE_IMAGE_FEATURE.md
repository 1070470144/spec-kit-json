# 生成图片功能文档

## 📋 功能概述

**生成图片**功能允许用户上传血染钟楼剧本的 JSON 文件，实时生成精美的预览图，并支持下载 SVG 和 PNG 格式。

## 🎯 功能特点

### 1. **上传 JSON 文件**
- 支持标准的血染钟楼剧本 JSON 格式
- 自动从 JSON 中提取剧本信息
- 支持数组格式和对象格式的 JSON

### 2. **可选信息填写**
- **剧本名字**：可选，不填则使用 JSON 中的标题
- **作者名字**：可选，不填则使用 JSON 中的作者

### 3. **实时预览**
- 上传后立即生成预览图
- 显示剧本的关键信息：
  - 剧本名称和作者
  - 角色统计（村民、外来者、爪牙、恶魔等）
  - 难度评级
  - 剧本类型
  - 角色列表（按阵营分类）
- **点击预览图**：在当前页面模态框中放大查看
- **悬停效果**：鼠标悬停显示查看图标
- **模态框功能**：
  - 全屏黑色半透明背景
  - 白色圆角卡片展示预览图
  - 右上角关闭按钮
  - 底部信息栏显示剧本名和作者
  - 模态框内可直接下载

### 4. **下载功能**
- **标准 PNG**：适合网络分享 (~1-2MB)
  - DPI: 240
  - 质量: 90
  - 文件命名：`剧本名_作者名.png`
- **超高清 PNG ★**：极致质量 适合专业打印 (~30-60MB)
  - DPI: 1200 (提升2倍)
  - 质量: 100 (无损)
  - 6倍放大 (提升1.5倍)
  - 文件命名：`剧本名_作者名_UHD.png`
- 下载按钮带加载状态提示
- 支持在预览模态框内下载
- 超高清版生成需要 15-30 秒，有明确提示

## 📍 访问路径

- **页面路径**：`/generate`
- **导航入口**：
  - 桌面端：顶部导航栏 → "生成图片"
  - 移动端：汉堡菜单 → "生成图片"

## 🔧 技术实现

### 页面组件
- **文件**：`app/generate/page.tsx`
- **功能**：
  - 文件上传
  - 预览图生成
  - 图片下载

### API 端点

#### 1. 生成临时预览图
- **路径**：`POST /api/scripts/temp-preview/generate`
- **请求体**：
  ```json
  {
    "id": "temp-generate",
    "title": "剧本名称",
    "author": "作者名称",
    "json": { /* 剧本JSON数据 */ }
  }
  ```
- **响应**：SVG 图片

#### 2. SVG 转 PNG
- **路径**：`POST /api/tools/convert-svg-to-png`
- **请求体**：
  ```json
  {
    "svg": "<svg>...</svg>",
    "quality": "normal" | "ultra"  // 可选，默认 "normal"
  }
  ```
- **响应**：PNG 图片
- **技术**：使用 `sharp` 库进行高质量转换
- **质量参数**：
  - `normal`：标准版 (240 DPI, 质量 90, ~1-2MB)
  - `ultra`：超高清版 (1200 DPI, 质量 100, 6倍放大, ~30-60MB)

## 🎨 预览图样式

- **尺寸**：280px × 700px（固定宽高比）
- **背景**：渐变色 + 装饰元素
- **布局**：
  - 顶部：剧本名称和作者
  - 中间：角色统计和信息
  - 底部：角色列表（按阵营分类）

## 📝 使用流程

1. 访问 `/generate` 页面
2. （可选）填写剧本名称和作者
3. 选择 JSON 文件
4. 点击"生成预览图"按钮
5. 查看生成的预览图
6. 点击预览图在模态框中放大查看
7. 下载选项：
   - 点击"下载 PNG (标准)"下载标准版（文件名：剧本名_作者名.png，~1-2MB）
   - 点击"下载超高清图 ★"下载超高清版（文件名：剧本名_作者名_UHD.png，~30-60MB，需等待15-30秒）
8. 或在模态框中选择"标准"或"超高清 ★"下载

## ⚙️ 优先级规则

### 标题优先级
1. 用户在表单中填写的标题
2. JSON 中的 `name` 字段
3. 默认值：`未命名剧本`

### 作者优先级
1. 用户在表单中填写的作者
2. JSON 中的 `author` 字段
3. 默认值：`未知作者`

## 🔒 权限要求

- **无需登录**：所有用户均可使用
- **无需上传**：不保存到数据库，纯客户端操作

## 📦 依赖库

- **sharp**：SVG 转 PNG 转换
- **React**：前端框架
- **Next.js**：全栈框架

## 🚀 部署注意事项

1. 确保 `sharp` 库已安装：
   ```bash
   npm install sharp@^0.33.5
   ```

2. 生产环境需要确保 `sharp` 的原生依赖正常工作

3. 如果 `sharp` 不可用，系统会尝试使用 `canvas` 库作为备选方案

## 🐛 已知问题

暂无

## 📄 相关文件

- 页面：`app/generate/page.tsx`
- API（临时预览）：`app/api/scripts/temp-preview/generate/route.ts`
- API（SVG转PNG）：`app/api/tools/convert-svg-to-png/route.ts`
- 导航：`app/_components/SiteHeader.tsx`
- 预览生成器：`src/generators/script-preview.ts`

## ✨ 界面特性

- ✅ **交互式预览**：点击预览图在当前页面模态框中放大查看
- ✅ **悬停效果**：鼠标悬停显示"查看"图标提示
- ✅ **模态框设计**：
  - 全屏黑色半透明背景（80%透明度 + 模糊效果）
  - 白色圆角卡片展示预览图
  - 右上角圆形关闭按钮（带悬停放大效果）
  - 底部信息栏显示剧本名和作者
  - 支持标准版和超高清版双下载选项
  - 点击背景或关闭按钮可关闭模态框
- ✅ **智能文件命名**：
  - 标准版：`剧本名_作者名.png`
  - 超高清版：`剧本名_作者名_UHD.png`
- ✅ **双质量下载**：
  - 标准版 (~1-2MB)：快速下载，适合网络分享
  - 超高清版 (~30-60MB)：极致质量（1200 DPI，6倍放大），适合专业打印收藏
- ✅ **加载状态**：
  - 标准版：显示"转换中..."
  - 超高清版：显示"生成中..."和预计等待时间
- ✅ **友好提示**：Toast 消息实时反馈操作结果，显示文件大小和耗时
- ✅ **响应式设计**：完美适配移动端和桌面端

## 🎯 未来改进

- [x] ~~支持超高清下载 (已完成)~~
- [ ] 支持自定义预览图样式
- [ ] 支持批量生成
- [ ] 支持更多导出格式（PDF、JPG等）
- [ ] 添加水印功能
- [ ] 支持预览图模板选择
- [ ] 添加图片编辑功能（裁剪、滤镜等）

## 📊 质量对比

| 版本 | 尺寸 | DPI | 质量 | 压缩 | 文件大小 | 生成时间 | 适用场景 |
|------|------|-----|------|------|----------|----------|----------|
| 标准PNG | 800×2000 | 240 | 90 | 9 (最高) | 1-2MB | 1-3秒 | 网络分享、在线展示 |
| 超高清PNG | 1680×4200 | 1200 | 100 | 0 (无压缩) | 30-60MB | 15-30秒 | 专业打印、收藏、极致质量需求 |

