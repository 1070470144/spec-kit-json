# ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“è¿ç§»æŒ‡å—

## ğŸ¯ ç›®æ ‡

å°†ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“ä»é¡¹ç›®å†…éƒ¨è¿ç§»åˆ°å¤–éƒ¨å­˜å‚¨ï¼Œè§£å†³å¤‡ä»½å†…å­˜ä¸è¶³é—®é¢˜ï¼Œæå‡éƒ¨ç½²æ•ˆç‡ã€‚

## âš ï¸ é‡è¦æé†’

**åœ¨æ‰§è¡Œä»»ä½•æ“ä½œå‰ï¼Œè¯·åŠ¡å¿…ï¼š**
1. âœ… åˆ›å»ºå®Œæ•´å¤‡ä»½
2. âœ… åœ¨ä½å³°æ—¶æ®µæ“ä½œ
3. âœ… å‡†å¤‡å›æ»šæ–¹æ¡ˆ
4. âœ… é€šçŸ¥ç”¨æˆ·å¯èƒ½çš„çŸ­æš‚ä¸­æ–­

## ğŸ“‹ æ“ä½œæ­¥éª¤

### æ­¥éª¤ 1ï¼šä¸Šä¼ æ›´æ–°åçš„è„šæœ¬

1. **ä¸‹è½½æœ€æ–°è„šæœ¬**
   ```bash
   # åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•
   git pull origin master
   ```

2. **ä¸Šä¼ åˆ°æœåŠ¡å™¨**
   ```powershell
   # æ–¹æ³•1: ç›´æ¥æ›¿æ¢
   # å°†æœ¬åœ° scripts/pm2-installer.ps1 ä¸Šä¼ åˆ°æœåŠ¡å™¨ C:\pm2-installer.ps1
   
   # æ–¹æ³•2: å¦‚æœæœ‰Gitè®¿é—®æƒé™
   cd C:\apps\juben
   git pull origin master
   ```

### æ­¥éª¤ 2ï¼šæ£€æŸ¥å½“å‰çŠ¶æ€

```powershell
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
powershell -ExecutionPolicy Bypass -File C:\pm2-installer.ps1

# é€‰æ‹©èœå•é¡¹: 14) æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
```

**é¢„æœŸè¾“å‡º**ï¼š
```
=== DATABASE STATUS ===

[i] æ•°æ®åº“ä½ç½®: é¡¹ç›®å†…éƒ¨ (ä¼ ç»Ÿæ¨¡å¼)
[i] è·¯å¾„: C:\apps\juben\prisma\dev.db
[i] å¤§å°: 15.8 MB
[i] å»ºè®®: è¿ç§»åˆ°å¤–éƒ¨å­˜å‚¨ä»¥ç®€åŒ–éƒ¨ç½²
[i] ç¯å¢ƒå˜é‡é…ç½®: file:./prisma/dev.db
```

### æ­¥éª¤ 3ï¼šåˆ›å»ºå®‰å…¨å¤‡ä»½

```powershell
# åœ¨èœå•ä¸­é€‰æ‹©: 9) backup database/uploads
# æˆ–æ‰‹åŠ¨å¤‡ä»½ï¼š
cd C:\apps\juben
mkdir backups-migration -Force
copy prisma\dev.db backups-migration\dev-backup-$(Get-Date -Format 'yyyyMMdd-HHmmss').db
xcopy uploads backups-migration\uploads-backup /E /I
```

### æ­¥éª¤ 4ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

```powershell
# åœ¨ PM2 å®‰è£…å™¨èœå•ä¸­é€‰æ‹©: 13) è¿ç§»æ•°æ®åº“åˆ°å¤–éƒ¨å­˜å‚¨
```

**è¿ç§»è¿‡ç¨‹ç¤ºä¾‹**ï¼š
```
=== MIGRATE DATABASE TO EXTERNAL STORAGE ===

å‡†å¤‡å°†æ•°æ®åº“è¿ç§»åˆ°å¤–éƒ¨å­˜å‚¨:
  ä»: C:\apps\juben\prisma\dev.db
  åˆ°: C:\apps\juben-data\database\juben.db
åŒæ—¶è¿ç§» uploads æ–‡ä»¶å¤¹:
  ä»: C:\apps\juben\uploads
  åˆ°: C:\apps\juben-data\uploads

ç¡®è®¤è¿ç§»? å»ºè®®å…ˆå¤‡ä»½! (y/n): y

[i] åœæ­¢ PM2 æœåŠ¡...
[i] åˆ›å»ºå¤–éƒ¨æ•°æ®ç›®å½•...
[i] è¿ç§»æ•°æ®åº“æ–‡ä»¶...
[OK] æ•°æ®åº“è¿ç§»å®Œæˆ
[i] è¿ç§» uploads æ–‡ä»¶å¤¹...
[OK] uploads æ–‡ä»¶å¤¹è¿ç§»å®Œæˆ
[i] æ›´æ–°é…ç½®...
[i] æ›´æ–°ç¯å¢ƒå˜é‡...
[i] é‡æ–°ç”Ÿæˆæ•°æ®åº“è¿æ¥...
[i] é‡å¯æœåŠ¡...

[OK] æ•°æ®åº“è¿ç§»å®Œæˆ!
[i] æ•°æ®åº“ç°åœ¨ä½äº: C:\apps\juben-data\database\juben.db
[i] ä¸‹æ¬¡ä»£ç æ›´æ–°å°†æ— éœ€å¤‡ä»½æ•°æ®åº“

æ˜¯å¦åˆ é™¤é¡¹ç›®å†…çš„æ—§æ•°æ®åº“å’Œuploadsæ–‡ä»¶å¤¹? (y/n): y
[OK] å·²åˆ é™¤å†…éƒ¨æ•°æ®åº“æ–‡ä»¶
[OK] å·²åˆ é™¤å†…éƒ¨ uploads æ–‡ä»¶å¤¹
```

### æ­¥éª¤ 5ï¼šéªŒè¯è¿ç§»ç»“æœ

1. **æ£€æŸ¥æ•°æ®åº“çŠ¶æ€**
   ```powershell
   # èœå•é¡¹: 14) æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
   ```
   
   **é¢„æœŸè¾“å‡º**ï¼š
   ```
   [OK] æ•°æ®åº“ä½ç½®: å¤–éƒ¨å­˜å‚¨ (æ¨èæ¨¡å¼)
   [i] è·¯å¾„: C:\apps\juben-data\database\juben.db
   [i] ç¯å¢ƒå˜é‡é…ç½®: file:C:/apps/juben-data/database/juben.db
   [i] çŠ¶æ€: å·²ä¼˜åŒ–ï¼Œä»£ç æ›´æ–°æ— éœ€å¤‡ä»½æ•°æ®åº“
   ```

2. **éªŒè¯åº”ç”¨åŠŸèƒ½**
   ```bash
   # è®¿é—®ç½‘ç«™ï¼Œæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼š
   # - ç”¨æˆ·ç™»å½•
   # - æµè§ˆå‰§æœ¬
   # - ä¸Šä¼ å›¾ç‰‡
   # - æ•°æ®æ˜¾ç¤ºæ­£å¸¸
   ```

3. **æ£€æŸ¥æ–‡ä»¶ç»“æ„**
   ```powershell
   # éªŒè¯å¤–éƒ¨æ•°æ®ç›®å½•
   ls C:\apps\juben-data
   # åº”è¯¥çœ‹åˆ°: database/, uploads/, backups/
   
   ls C:\apps\juben-data\database
   # åº”è¯¥çœ‹åˆ°: juben.db
   
   ls C:\apps\juben-data\uploads
   # åº”è¯¥çœ‹åˆ°è¿ç§»çš„ä¸Šä¼ æ–‡ä»¶
   ```

### æ­¥éª¤ 6ï¼šæµ‹è¯•å¤‡ä»½åŠŸèƒ½

```powershell
# èœå•é¡¹: 9) backup database/uploads
```

**é¢„æœŸè¾“å‡º**ï¼š
```
=== BACKUP DATABASE & UPLOADS ===

[i] æ£€æµ‹åˆ°æ•°æ®åº“ä½ç½®: external
[i] ä½¿ç”¨å¤–éƒ¨å­˜å‚¨å¤‡ä»½æ¨¡å¼
[i] uploads æ–‡ä»¶å¤¹å¤§å°: 2.34 GB
[i] æ•°æ®åº“å¤§å°: 15.8 MB
[OK] backup saved: C:\apps\juben-data\backups\data-backup-20251014-143022.zip
[i] âœ“ å¤–éƒ¨å­˜å‚¨æ¨¡å¼ï¼šä»£ç æ›´æ–°æ—¶æ— éœ€å¤‡ä»½æ•°æ®
```

### æ­¥éª¤ 7ï¼šæµ‹è¯•ä»£ç æ›´æ–°æµç¨‹

```powershell
# æ¨¡æ‹Ÿä»£ç æ›´æ–°: èœå•é¡¹ 12) one-key update
```

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… æ›´æ–°é€Ÿåº¦æ˜¾è‘—æå‡ï¼ˆä»å‡ åˆ†é’Ÿåˆ°30ç§’ï¼‰
- âœ… æ— å†…å­˜ä¸è¶³é”™è¯¯
- âœ… æ•°æ®å®Œå…¨ä¿ç•™

---

## ğŸ—‚ï¸ è¿ç§»åçš„ç›®å½•ç»“æ„

### ç”Ÿäº§ç¯å¢ƒç»“æ„
```
C:\apps\juben\          # ğŸ”„ é¡¹ç›®ä»£ç ç›®å½•ï¼ˆæ›´æ–°æ—¶è¦†ç›–ï¼‰
â”œâ”€â”€ prisma\
â”‚   â””â”€â”€ schema.prisma   # åªä¿ç•™ schema æ–‡ä»¶
â”œâ”€â”€ .env                # æŒ‡å‘å¤–éƒ¨æ•°æ®åº“
â”œâ”€â”€ package.json
â””â”€â”€ ... å…¶ä»–ä»£ç æ–‡ä»¶

C:\apps\juben-data\     # ğŸ’¾ å¤–éƒ¨æ•°æ®ç›®å½•ï¼ˆæ°¸ä¸å˜åŠ¨ï¼‰
â”œâ”€â”€ database\
â”‚   â””â”€â”€ juben.db        # è¿ç§»åçš„æ•°æ®åº“
â”œâ”€â”€ uploads\            # è¿ç§»åçš„ä¸Šä¼ æ–‡ä»¶
â””â”€â”€ backups\            # æ•°æ®å¤‡ä»½ç›®å½•
```

### ç¯å¢ƒå˜é‡æ›´æ–°
```env
# è¿ç§»å‰ (.env)
DATABASE_URL="file:./prisma/dev.db"

# è¿ç§»å (.env)
DATABASE_URL="file:C:/apps/juben-data/database/juben.db"
UPLOADS_PATH="C:/apps/juben-data/uploads"
```

---

## ğŸš¨ æ•…éšœæ’é™¤

### é—®é¢˜ 1ï¼šè¿ç§»è¿‡ç¨‹ä¸­æ–­
**ç°è±¡**ï¼šè¿ç§»è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯æˆ–ä¸­æ–­

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# 1. æ¢å¤å¤‡ä»½
cd C:\apps\juben
copy backups-migration\dev-backup-*.db prisma\dev.db
xcopy backups-migration\uploads-backup uploads /E /I

# 2. é‡å¯æœåŠ¡
npx pm2 restart juben

# 3. æ£€æŸ¥é”™è¯¯æ—¥å¿—åé‡è¯•
```

### é—®é¢˜ 2ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥
**ç°è±¡**ï¼šè¿ç§»åæœåŠ¡æ— æ³•å¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# æ£€æŸ¥ç¯å¢ƒå˜é‡
type C:\apps\juben\.env
# ç¡®è®¤ DATABASE_URL è·¯å¾„æ­£ç¡®

# æ‰‹åŠ¨æµ‹è¯•æ•°æ®åº“è¿æ¥
cd C:\apps\juben
npx prisma db push
npx prisma generate

# é‡å¯æœåŠ¡
npx pm2 restart juben
```

### é—®é¢˜ 3ï¼šæ•°æ®ä¸¢å¤±
**ç°è±¡**ï¼šè¿ç§»åéƒ¨åˆ†æ•°æ®ä¸¢å¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# 1. ç«‹å³åœæ­¢æœåŠ¡
npx pm2 stop juben

# 2. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls C:\apps\juben-data\database\juben.db
# å¯¹æ¯”æ–‡ä»¶å¤§å°å’Œä¿®æ”¹æ—¶é—´

# 3. å¦‚éœ€è¦ï¼Œæ¢å¤å¤‡ä»½
copy backups-migration\dev-backup-*.db C:\apps\juben-data\database\juben.db

# 4. é‡å¯æœåŠ¡
npx pm2 restart juben
```

### é—®é¢˜ 4ï¼šä¸Šä¼ åŠŸèƒ½å¼‚å¸¸
**ç°è±¡**ï¼šæ–‡ä»¶ä¸Šä¼ å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```powershell
# æ£€æŸ¥ uploads ç›®å½•æƒé™
icacls C:\apps\juben-data\uploads
# ç¡®ä¿åº”ç”¨è¿›ç¨‹æœ‰è¯»å†™æƒé™

# æ£€æŸ¥ç¯å¢ƒå˜é‡
# ç¡®è®¤ UPLOADS_PATH é…ç½®æ­£ç¡®
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### è¿ç§»å‰ vs è¿ç§»å

| æ“ä½œ | è¿ç§»å‰ | è¿ç§»å | æ”¹å–„ |
|------|--------|--------|------|
| **ä»£ç æ›´æ–°å¤‡ä»½** | 2-5åˆ†é’Ÿï¼Œå‡ GB | è·³è¿‡å¤‡ä»½ | **èŠ‚çœ100%æ—¶é—´** |
| **æ›´æ–°æ€»æ—¶é—´** | 5-10åˆ†é’Ÿ | 30ç§’-1åˆ†é’Ÿ | **æå‡10å€é€Ÿåº¦** |
| **å†…å­˜å ç”¨** | é«˜ï¼ˆç»å¸¸è¶…é™ï¼‰ | ä½ï¼ˆæ— å‹åŠ›ï¼‰ | **è§£å†³å†…å­˜é—®é¢˜** |
| **æ•°æ®å®‰å…¨** | ä¸­ï¼ˆæ›´æ–°æœ‰é£é™©ï¼‰ | é«˜ï¼ˆå®Œå…¨éš”ç¦»ï¼‰ | **å®‰å…¨æ€§æå‡** |

---

## âœ… è¿ç§»æ¸…å•

**è¿ç§»å‰**ï¼š
- [ ] åˆ›å»ºå®Œæ•´å¤‡ä»½
- [ ] ä¸Šä¼ æœ€æ–°çš„ pm2-installer.ps1 è„šæœ¬
- [ ] é€‰æ‹©ä½å³°æ—¶æ®µæ“ä½œ
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

**è¿ç§»ä¸­**ï¼š
- [ ] è¿è¡Œèœå•é¡¹ 14 æ£€æŸ¥çŠ¶æ€
- [ ] è¿è¡Œèœå•é¡¹ 13 æ‰§è¡Œè¿ç§»
- [ ] ç¡®è®¤è¿ç§»è¿‡ç¨‹æ— é”™è¯¯
- [ ] é€‰æ‹©åˆ é™¤æ—§æ–‡ä»¶

**è¿ç§»å**ï¼š
- [ ] éªŒè¯æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º"å¤–éƒ¨å­˜å‚¨"
- [ ] æµ‹è¯•ç½‘ç«™æ ¸å¿ƒåŠŸèƒ½
- [ ] éªŒè¯æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- [ ] æµ‹è¯•å¤‡ä»½åŠŸèƒ½
- [ ] æµ‹è¯•ä»£ç æ›´æ–°æµç¨‹

---

## ğŸ‰ è¿ç§»æˆåŠŸæ ‡å¿—

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œè¯´æ˜è¿ç§»æˆåŠŸï¼š

1. **èœå•æ˜¾ç¤º**ï¼š`DB: å¤–éƒ¨å­˜å‚¨ âœ“`
2. **å¤‡ä»½æç¤º**ï¼š`âœ“ å¤–éƒ¨å­˜å‚¨æ¨¡å¼ï¼šä»£ç æ›´æ–°æ—¶æ— éœ€å¤‡ä»½æ•°æ®`
3. **æ›´æ–°é€Ÿåº¦**ï¼šä»£ç æ›´æ–°ä»å‡ åˆ†é’Ÿé™åˆ°30ç§’
4. **æ— å†…å­˜é”™è¯¯**ï¼šå¤‡ä»½è¿‡ç¨‹ä¸å†å‡ºç°å†…å­˜ä¸è¶³
5. **æ•°æ®å®Œæ•´**ï¼šæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œæ•°æ®æ— ä¸¢å¤±

---

## ğŸ“ ç´§æ€¥å›æ»š

å¦‚æœè¿ç§»åå‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```powershell
# 1. åœæ­¢æœåŠ¡
npx pm2 stop juben

# 2. æ¢å¤åŸæ•°æ®åº“
cd C:\apps\juben
copy backups-migration\dev-backup-*.db prisma\dev.db
xcopy backups-migration\uploads-backup uploads /E /I

# 3. æ¢å¤ç¯å¢ƒå˜é‡
# æ‰‹åŠ¨ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ”¹å›ï¼š
# DATABASE_URL="file:./prisma/dev.db"

# 4. é‡å¯æœåŠ¡
npx pm2 restart juben
```

---

**è¿ç§»å®Œæˆåï¼Œä½ çš„ç”Ÿäº§ç¯å¢ƒå°†å½»åº•è§£å†³å¤‡ä»½å†…å­˜é—®é¢˜ï¼Œä»£ç æ›´æ–°æ•ˆç‡æå‡10å€ï¼** ğŸš€
